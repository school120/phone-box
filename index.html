<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Phone Box Checker — Bottom‑of‑Phone Debug + Slot Overlay</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{ background:#fff; border-radius:1rem; box-shadow:0 4px 20px rgba(0,0,0,.08); padding:1rem; }
    .btn{ padding:.5rem .75rem; border:1px solid #ddd; border-radius:1rem; }
    .btn-primary{ background:#111827; color:#fff; border-color:#111827; }
    .overlay-wrap{ position:relative; }
    .overlay-canvas{ position:absolute; left:0; top:0; pointer-events:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div id="root" class="p-4 sm:p-6"></div>

  <script>
  const { useEffect, useRef, useState } = React;

  // Orientation options; default to 12×5 since your labels run left→right across 12
  const ORIENTS = [ {rows:12, cols:5, name:'12×5'}, {rows:5, cols:12, name:'5×12'} ];

  // Robust threshold (median + 1.5*MAD)
  function robustThreshold(values){
    const a=[...values].sort((x,y)=>x-y); const n=a.length; if(!n) return 0.02;
    const med = n%2? a[(n-1)/2] : (a[n/2-1]+a[n/2])/2;
    const ad = a.map(v=>Math.abs(v-med)).sort((x,y)=>x-y);
    const mad = n%2? ad[(n-1)/2] : (ad[n/2-1]+ad[n/2])/2;
    let t = med + 1.5*mad; if(!isFinite(t)||t<=0) t = med*1.25 + 0.003; return Math.min(Math.max(t, med*1.05), med+0.05);
  }

  function Header(){
    return React.createElement('div',{className:'mb-3'},[
      React.createElement('h1',{className:'text-2xl sm:text-3xl font-bold'},'Phone Box Checker — Bottom-of-Phone Debug'),
      React.createElement('p',{className:'text-xs text-gray-600'},'We specifically look for the *bottom of a phone just above each blue number*. The overlay shows the 60 scan windows (green = full-slot, yellow = bottom band).')
    ]);
  }

  function App(){
    const [orientIdx,setOrientIdx]=useState(0); // 0: 12×5 (default), 1: 5×12
    const [imageURL,setImageURL]=useState(null);
    const [busy,setBusy]=useState(false);
    const [debugInfo,setDebugInfo]=useState(null);

    const imgRef=useRef(null);
    const workCanvasRef=useRef(null);
    const overlayRef=useRef(null);

    const onPhoto=(file)=>{ setImageURL(URL.createObjectURL(file)); setDebugInfo(null); };

    function drawOverlay(rectsFull, rectsBottom, W, H){
      const imgEl = imgRef.current; const ov = overlayRef.current; if(!imgEl || !ov) return;
      const dispW = imgEl.clientWidth; const dispH = imgEl.clientHeight; ov.width = dispW; ov.height = dispH;
      const scaleX = dispW / W; const scaleY = dispH / H; const ctx = ov.getContext('2d'); ctx.clearRect(0,0,ov.width,ov.height);
      ctx.lineWidth = 2; ctx.font = '10px sans-serif'; ctx.textBaseline='top';
      // Full slot windows (green)
      ctx.strokeStyle = 'rgba(0,200,0,0.95)';
      rectsFull.forEach((r,i)=>{ ctx.strokeRect(r.x*scaleX, r.y*scaleY, r.w*scaleX, r.h*scaleY); const sx=r.x*scaleX+2, sy=r.y*scaleY+2; ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(sx,sy,18,12); ctx.fillStyle='#fff'; ctx.fillText(String(i+1), sx+3, sy+1); });
      // Bottom bands (yellow)
      ctx.strokeStyle = 'rgba(240,200,0,0.95)';
      rectsBottom.forEach((r)=>{ ctx.strokeRect(r.x*scaleX, r.y*scaleY, r.w*scaleX, r.h*scaleY); });
    }

    const analyze=async()=>{
      if(!imageURL) { alert('Take/Upload a photo first.'); return; }
      if(!window.cv){ alert('OpenCV not ready yet.'); return; }
      setBusy(true);

      const img = imgRef.current; const work = workCanvasRef.current; const W = img.naturalWidth, H = img.naturalHeight; const wctx = work.getContext('2d'); work.width=W; work.height=H; wctx.drawImage(img,0,0,W,H);
      const cv=window.cv; const mat = cv.imread(work);

      // Grid from orient selection
      const {rows, cols} = ORIENTS[orientIdx];
      const cellW = Math.floor(W/cols), cellH = Math.floor(H/rows);

      const fullRects=[]; const bottomRects=[]; const densities=[]; const bottomDensities=[]; const present=[];

      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const x=c*cellW, y=r*cellH;
          // full slot crop — inset slightly to avoid dividers
          const fx = x + Math.floor(cellW*0.08), fy = y + Math.floor(cellH*0.08);
          const fw = Math.floor(cellW*0.84), fh = Math.floor(cellH*0.84);
          fullRects.push({x:fx,y:fy,w:fw,h:fh});
          // bottom band crop — the thing you asked for (just above blue number)
          const bx = x + Math.floor(cellW*0.10), by = y + Math.floor(cellH*0.70);
          const bw = Math.floor(cellW*0.80), bh = Math.floor(cellH*0.18);
          bottomRects.push({x:bx,y:by,w:bw,h:bh});

          // Edge density for full slot
          const roiFull = new cv.Rect(fx,fy,fw,fh); const cellFull = mat.roi(roiFull);
          const g1=new cv.Mat(); cv.cvtColor(cellFull,g1,cv.COLOR_RGBA2GRAY); const b1=new cv.Mat(); cv.GaussianBlur(g1,b1,new cv.Size(5,5),0,0,cv.BORDER_DEFAULT); const e1=new cv.Mat(); cv.Canny(b1,e1,35,120);
          densities.push(cv.countNonZero(e1)/(fw*fh)); g1.delete(); b1.delete(); e1.delete(); cellFull.delete();

          // Edge density for bottom band (your main signal)
          const roiB = new cv.Rect(bx,by,bw,bh); const cellB = mat.roi(roiB);
          const g2=new cv.Mat(); cv.cvtColor(cellB,g2,cv.COLOR_RGBA2GRAY); const b2=new cv.Mat(); cv.GaussianBlur(g2,b2,new cv.Size(3,3),0,0,cv.BORDER_DEFAULT); const e2=new cv.Mat(); cv.Canny(b2,e2,30,100);
          bottomDensities.push(cv.countNonZero(e2)/(bw*bh)); g2.delete(); b2.delete(); e2.delete(); cellB.delete();
        }
      }

      // Decide presence. We emphasize the bottom band; fall back to full slot if ambiguous
      const thrFull = robustThreshold(densities);
      const thrBottom = robustThreshold(bottomDensities);
      for(let i=0;i<densities.length;i++){
        const bottomLikely = bottomDensities[i] > thrBottom; // sign of phone bottom features
        const fullLikely = densities[i] > thrFull;            // general presence backup
        present.push(bottomLikely || fullLikely);
      }

      // Draw overlay rectangles (green full slots, yellow bottom bands)
      drawOverlay(fullRects, bottomRects, W, H);

      setBusy(false);
      setDebugInfo({ rows, cols, presentCount: present.filter(Boolean).length, thrFull, thrBottom, sampleFull: densities.slice(0,12), sampleBottom: bottomDensities.slice(0,12) });
      mat.delete();
    };

    return React.createElement('div',{className:'max-w-5xl mx-auto space-y-4'},[
      React.createElement(Header,{}),

      React.createElement('div',{className:'card'},[
        React.createElement('div',{className:'flex flex-wrap items-center gap-2'},[
          React.createElement('label',{className:'btn'},['Take/Upload Photo', React.createElement('input',{type:'file',accept:'image/*',capture:'environment',className:'hidden',onChange:e=>{ const f=e.target.files?.[0]; if(f) onPhoto(f); }})]),
          React.createElement('div',{className:'flex items-center gap-2 text-sm'},[
            React.createElement('span',{},'Grid:'),
            ...ORIENTS.map((o,i)=> React.createElement('label',{key:o.name,className:'flex items-center gap-1'},[
              React.createElement('input',{type:'radio',name:'orient',checked:orientIdx===i,onChange:()=>setOrientIdx(i)}),
              o.name
            ]))
          ]),
          React.createElement('button',{className:'btn btn-primary',disabled:busy || !imageURL, onClick:analyze}, busy? 'Analyzing…' : 'Analyze & Show Rectangles')
        ])
      ]),

      React.createElement('div',{className:'card'},[
        React.createElement('h3',{className:'font-semibold mb-2'},'Photo + Scan Overlay'),
        React.createElement('div',{className:'overlay-wrap'},[
          imageURL ? React.createElement('img',{ref:imgRef,src:imageURL,alt:'box',className:'w-full h-auto rounded'}) : React.createElement('div',{className:'text-sm text-gray-500 p-8'},'Add a photo to see green rectangles for all 60 slots (yellow bands mark the “bottom‑of‑phone” region).'),
          React.createElement('canvas',{ref:overlayRef,className:'overlay-canvas'})
        ]),
        React.createElement('canvas',{ref:workCanvasRef,className:'hidden'})
      ]),

      debugInfo && React.createElement('div',{className:'card text-sm space-y-1'},[
        React.createElement('div',{},`Grid: ${debugInfo.rows}×${debugInfo.cols}; Present count (est.): ${debugInfo.presentCount}`),
        React.createElement('div',{},`Thresholds — full=${debugInfo.thrFull.toFixed(4)}, bottom=${debugInfo.thrBottom.toFixed(4)}`),
        React.createElement('div',{className:'text-gray-500'},`Sample densities (full): ${debugInfo.sampleFull.map(x=>x.toFixed(4)).join(', ')}`),
        React.createElement('div',{className:'text-gray-500'},`Sample densities (bottom): ${debugInfo.sampleBottom.map(x=>x.toFixed(4)).join(', ')}`)
      ])
    ]);
  }

  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
