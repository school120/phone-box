<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Phone Box Attendance â€” Manual 5Ã—(L/R) Cal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root { --bg:#0b1020; --card:#121833; --muted:#8ea0d0; --accent:#3ad0ff; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--bg);color:#fff}
  header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:12px}
  .badge{background:rgba(255,255,255,.1);padding:4px 8px;border-radius:999px;font-size:12px}
  main{max-width:1100px;margin:0 auto;padding:12px}
  .wrap{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h2{margin:0 0 12px;font-weight:800}
  label{display:block;margin:.5rem 0 .35rem;color:var(--muted);font-size:14px}
  select,input[type="file"],button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0e1533;color:#fff}
  button.primary{background:linear-gradient(180deg,#39bdf2,#1aa1d9);border:none;font-weight:700}
  small{color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  #stage{position:relative;width:100%;aspect-ratio:3/5;background:#0d1330;border-radius:12px;display:flex;align-items:center;justify-content:center;border:1px dashed rgba(255,255,255,.18);overflow:hidden}
  #img{width:100%;height:100%;object-fit:cover;display:none}
  #canvas{position:absolute;inset:0}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 6px;text-align:left}
  tr.mismatch{background:rgba(255,80,80,.12)}
  tr.ok{opacity:.65}
  .pill{display:inline-block;padding:.15rem .45rem;border-radius:999px;background:rgba(255,255,255,.12);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:6px}
  .slot{background:#0f1738;border:1px solid rgba(255,255,255,.08);aspect-ratio:3/5;border-radius:8px;position:relative}
  .slot span{position:absolute;inset:auto 6px 6px 6px;font-size:10px;color:var(--muted)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
  .controls.sticky{position:sticky;bottom:0;z-index:5;background:linear-gradient(180deg,rgba(18,24,51,0),var(--card));padding-bottom:10px}
  @media (max-width: 820px) {
    main{padding:8px}
    .wrap{grid-template-columns:1fr;gap:12px}
    .row{grid-template-columns:1fr;gap:8px}
    button,select,input[type="file"]{padding:14px 16px;font-size:16px}
    table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;white-space:nowrap;border-radius:12px}
    th,td{padding:10px 8px}
  }
</style>
</head>
<body>
<header>
  <div style="font-weight:800">ðŸ“± Phone Box Attendance</div>
  <div class="badge">Manual 5 rows Ã— per-row left/right â€¢ 12 slots each</div>
</header>
<main>
  <div class="wrap">
    <section class="card">
      <h2>Scan a Box</h2>
      <div class="row">
        <div>
          <label>Choose box</label>
          <select id="box">
            <option value="">(no box)</option>
            <optgroup label="Grade Boxes" id="gradeBoxes"></optgroup>
            <optgroup label="Special"><option>SM1</option><option>SM2</option></optgroup>
          </select>
        </div>
        <div>
          <label>Roster CSV</label>
          <select id="rosterChoice">
            <option value="./data/roster.csv">Use repo roster (./data/roster.csv)</option>
            <option value="upload">Upload CSVâ€¦</option>
          </select>
          <input id="rosterUpload" type="file" accept=".csv" style="display:none;margin-top:6px" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Take/Upload a photo</label>
          <input id="photo" type="file" accept="image/*" capture="environment" />
        </div>
        <div>
          <label>Calibration</label>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button id="reset" class="primary">Reset guides (even spacing)</button>
            <button id="save">Save guides to this box</button>
            <button id="load">Load saved guides</button>
          </div>
          <small>Drag the <b>cyan</b> line of each row to the blue number strip. Drag the two <b>yellow</b> handles per row (left/right) so the 12 slots cover only the numbered pads (ignore walls/foam).</small>
        </div>
      </div>

      <div id="stage" style="margin-top:12px">
        <img id="img" alt="preview"/>
        <canvas id="canvas"></canvas>
      </div>

      <div class="controls sticky">
        <button class="primary" id="analyze">Analyze Attendance</button>
        <label style="display:flex;align-items:center;gap:8px;margin-left:8px">
          <input id="showRects" type="checkbox" checked style="width:auto"> Show rectangles
        </label>
      </div>
      <small id="status"></small>
    </section>

    <section class="card">
      <h2>Results</h2>
      <div id="boxGrid" class="grid" style="margin-bottom:10px"></div>
      <table>
        <thead><tr><th>Slot</th><th>Expected</th><th>Detected</th><th>Status</th></tr></thead>
        <tbody id="results"></tbody>
      </table>
    </section>
  </div>
</main>

<script>
/* ---------- Basic UI setup ---------- */
const BOX_IDS=[]; ['9','10','11','12'].forEach(g=>['A','B','C','D','E','F'].forEach(l=>BOX_IDS.push(`${g}${l}`)));
const gradeBoxes=document.getElementById('gradeBoxes'); BOX_IDS.forEach(id=>{const o=document.createElement('option');o.textContent=o.value=id;gradeBoxes.appendChild(o);});

const photo=document.getElementById('photo');
const img=document.getElementById('img');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const boxSel=document.getElementById('box');
const statusEl=document.getElementById('status');
const showRects=document.getElementById('showRects');
const resultsBody=document.getElementById('results');
const rosterChoice=document.getElementById('rosterChoice');
const rosterUpload=document.getElementById('rosterUpload');
const boxGrid=document.getElementById('boxGrid');

let roster=[];
let guides = null;  // [{y, xL, xR}, x normalized to width, y normalized to height]
let rois = [];      // computed rectangles in normalized coords
let imgW=0, imgH=0;

rosterChoice.addEventListener('change',()=>{ rosterUpload.style.display = rosterChoice.value==='upload'?'block':'none'; });

/* ---------- Roster ---------- */
async function loadRoster(){
  return new Promise((resolve)=>{
    if(rosterChoice.value==='upload'){
      if(!rosterUpload.files[0]) return resolve([]);
      Papa.parse(rosterUpload.files[0], {header:true, complete:r=>resolve(r.data)});
    } else {
      Papa.parse('./data/roster.csv', {download:true, header:true, complete:r=>resolve(r.data)});
    }
  });
}
function securityToBoxSlot(sec){
  if(!sec) return null; const s=String(sec).replace(/\s+/g,'').toUpperCase();
  const m=s.match(/^(SM\d|\d{1,2}[A-F])[- ]?(\d{1,2})$/);
  if(!m) return null; return {box:m[1], slot:parseInt(m[2],10)};
}
function rosterByBox(boxId){
  const map={}; for(const row of roster){
    const info=securityToBoxSlot(row['Security Number']||row['SecurityNumber']);
    if(info && info.box===boxId) map[info.slot]=row['Full Name'];
  } return map;
}
function renderGrid(namesBySlot={}){
  boxGrid.innerHTML='';
  for(let r=0;r<5;r++) for(let c=0;c<12;c++){
    const idx=r*12+c+1;
    const d=document.createElement('div'); d.className='slot';
    const s=document.createElement('span'); s.textContent=namesBySlot[idx]||`#${idx}`;
    d.appendChild(s); boxGrid.appendChild(d);
  }
}

/* ---------- Image / canvas ---------- */
photo.addEventListener('change',()=>{
  const f=photo.files[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  img.onload=()=>{
    img.style.display='block';
    imgW=img.naturalWidth; imgH=img.naturalHeight;
    fitCanvas();
    resetGuides(); // initial even guides
    draw();
  };
  img.src=url;
});
window.addEventListener('resize', fitCanvas);
function fitCanvas(){
  canvas.width=img.clientWidth||canvas.clientWidth;
  canvas.height=img.clientHeight||canvas.clientHeight;
}

/* ---------- Guides + ROI generation ---------- */
function resetGuides(){
  // five rows, roughly where number bars usually are
  guides = [0.22,0.40,0.58,0.76,0.94].map(y=>({ y, xL:0.06, xR:0.94 }));
  computeROIs();
}
function saveGuides(){
  if(!boxSel.value) return alert('Choose a box first.');
  localStorage.setItem('pbx_guides_'+boxSel.value, JSON.stringify(guides));
  alert('Saved guides for '+boxSel.value);
}
function loadGuides(){
  if(!boxSel.value) return alert('Choose a box first.');
  const raw=localStorage.getItem('pbx_guides_'+boxSel.value);
  if(!raw) return alert('No saved guides for '+boxSel.value);
  guides = JSON.parse(raw);
  computeROIs(); draw();
}
document.getElementById('reset').onclick=()=>{ resetGuides(); draw(); };
document.getElementById('save').onclick=saveGuides;
document.getElementById('load').onclick=loadGuides;
document.getElementById('analyze').onclick=analyze;
showRects.addEventListener('change', draw);

function computeROIs(){
  rois=[];
  // determine detection height from row spacing
  const gaps=[]; for(let i=1;i<guides.length;i++) gaps.push(guides[i].y - guides[i-1].y);
  const rowGap = (gaps.reduce((a,b)=>a+b,0)/gaps.length) || (1/5);
  const h = Math.min(0.25, rowGap*0.70); // height (as fraction of imgH)

  for(const g of guides){
    const yBottom=g.y;
    const yTop=Math.max(0, yBottom - h);
    for(let c=0;c<12;c++){
      const x0=g.xL + (c/12)*(g.xR-g.xL);
      const x1=g.xL + ((c+1)/12)*(g.xR-g.xL);
      // inset 12% inside each column; extra 20% on edges
      const base=(x1-x0)*0.12, edge=(c===0||c===11)?(x1-x0)*0.20:0;
      const xa=x0+Math.max(base,edge), xb=x1-Math.max(base,edge);
      rois.push({x:xa, y:yTop, w:Math.max(0.001,xb-xa), h:Math.max(0.001,yBottom-yTop)});
    }
  }
}

/* ---------- Drawing ---------- */
function draw(){
  if(!imgW) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // draw guides
  guides.forEach((g,i)=>{
    const y=g.y*canvas.height;
    // cyan row line
    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#3ad0ff';
    ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
    // yellow handles
    ctx.strokeStyle='#ffd63a'; ctx.lineWidth=1.25;
    const xL=g.xL*canvas.width, xR=g.xR*canvas.width;
    ctx.beginPath(); ctx.moveTo(xL,y-20); ctx.lineTo(xL,y+20); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(xR,y-20); ctx.lineTo(xR,y+20); ctx.stroke();
    // small handle circles
    ctx.fillStyle='#ffd63a';
    ctx.beginPath(); ctx.arc(xL,y,5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(xR,y,5,0,Math.PI*2); ctx.fill();
  });
  // draw rois
  if(showRects.checked){
    ctx.strokeStyle='rgba(255,255,255,.95)'; ctx.lineWidth=2;
    rois.forEach(r=>{
      ctx.strokeRect(r.x*canvas.width, r.y*canvas.height, r.w*canvas.width, r.h*canvas.height);
    });
  }
}

/* ---------- Drag logic (rows + per-row L/R) ---------- */
let drag = null; // {type:'row'|'L'|'R', idx, dy or dx offsets}
canvas.addEventListener('pointerdown', (e)=>{
  if(!guides) return;
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left), y=(e.clientY-rect.top);
  // find nearest handle within 16px: left or right or row
  let best=null, bestD=1e9;
  guides.forEach((g,i)=>{
    const ypx=g.y*canvas.height;
    const xL=g.xL*canvas.width, xR=g.xR*canvas.width;
    const dRow=Math.abs(y-ypx);
    const dL=Math.hypot(x-xL,y-ypx);
    const dR=Math.hypot(x-xR,y-ypx);
    if(dL<bestD && dL<16) { best={type:'L',idx:i,dx:x-xL}; bestD=dL; }
    if(dR<bestD && dR<16) { best={type:'R',idx:i,dx:x-xR}; bestD=dR; }
    if(dRow<bestD && dRow<12) { best={type:'row',idx:i,dy:y-ypx}; bestD=dRow; }
  });
  drag=best;
});
canvas.addEventListener('pointermove', (e)=>{
  if(!drag) return;
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left), y=(e.clientY-rect.top);
  const i=drag.idx; const g=guides[i];
  if(drag.type==='row'){
    let ny=(y-drag.dy)/canvas.height; ny=Math.max(0.02, Math.min(0.98, ny));
    // keep rows ordered
    if(i>0) ny=Math.max(ny, guides[i-1].y+0.03);
    if(i<guides.length-1) ny=Math.min(ny, guides[i+1].y-0.03);
    g.y=ny;
  } else if(drag.type==='L'){
    let nx=(x-drag.dx)/canvas.width; nx=Math.max(0.0, Math.min(g.xR-0.02, nx));
    g.xL=nx;
  } else if(drag.type==='R'){
    let nx=(x-drag.dx)/canvas.width; nx=Math.min(1.0, Math.max(g.xL+0.02, nx));
    g.xR=nx;
  }
  computeROIs(); draw();
});
window.addEventListener('pointerup', ()=>drag=null);
window.addEventListener('pointercancel', ()=>drag=null);

/* ---------- Analyze (presence only; simple + robust) ---------- */
function cropCanvas(srcImg, roi){ // returns an offscreen canvas of ROI
  const c=document.createElement('canvas');
  c.width=Math.round(roi.w*imgW); c.height=Math.round(roi.h*imgH);
  const sx=roi.x*imgW, sy=roi.y*imgH;
  c.getContext('2d').drawImage(srcImg, sx, sy, roi.w*imgW, roi.h*imgH, 0,0,c.width,c.height);
  return c;
}
function slotOccupied(canvasROI){
  const cx=Math.round(canvasROI.width*0.20), cw=Math.round(canvasROI.width*0.60);
  const cy=Math.round(canvasROI.height*0.15), ch=Math.round(canvasROI.height*0.60);
  const ctx=canvasROI.getContext('2d');
  const {data} = ctx.getImageData(cx,cy,cw,ch);
  const cols=new Float32Array(cw).fill(0); const darkCut=130;
  for(let y=0;y<ch;y++){
    for(let x=0;x<cw;x++){
      const i=(y*cw+x)*4;
      const L=0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];
      if(L<darkCut) cols[x]++;
    }
  }
  for(let x=0;x<cw;x++) cols[x]/=ch;
  let best=0,run=0; for(let x=0;x<cw;x++){ if(cols[x]>0.5){ run++; best=Math.max(best,run);} else run=0; }
  return best>=Math.round(cw*0.25);
}

async function analyze(){
  if(!img.src){ alert('Add a photo first.'); return; }
  const namesBySlot = boxSel.value ? rosterByBox(boxSel.value) : {};
  renderGrid(namesBySlot);

  const records=[];
  for(let i=0;i<rois.length;i++){
    const roi=rois[i];
    const roiCanvas=cropCanvas(img, roi);
    const occ=slotOccupied(roiCanvas);

    const slot=i+1;
    const expected=namesBySlot[slot]||'';
    let status = occ ? (expected?'present':'unexpected phone') : (expected?'missing':'empty');

    records.push({slot, expectedName: expected, detectedId: occ?'â€”':'â€”', status});
  }

  // render table
  resultsBody.innerHTML='';
  for(const r of records){
    const tr=document.createElement('tr');
    tr.className = r.status==='present' ? 'ok' : (r.status==='missing' ? 'mismatch' : '');
    tr.innerHTML=`<td>${r.slot}</td><td>${r.expectedName||''}</td><td>${r.detectedId||''}</td><td><span class="pill">${r.status}</span></td>`;
    resultsBody.appendChild(tr);
  }
  statusEl.textContent='Done.';
}

/* ---------- Init ---------- */
document.getElementById('box').addEventListener('change', async ()=>{
  roster=await loadRoster(); renderGrid(boxSel.value?rosterByBox(boxSel.value):{});
});
(async function init(){
  roster=await loadRoster(); renderGrid();
})();
</script>
</body>
</html>
