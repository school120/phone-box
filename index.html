<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phone Box Checker</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    canvas { max-width: 100%; border: 1px solid #ccc; }
    #missingList { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Phone Box Checker</h1>
  <input type="file" accept="image/*" id="imageInput"><br><br>
  <canvas id="canvas"></canvas>
  <div id="missingList"></div>
  <button onclick="emailMissing()">Email Missing Students</button>

  <script>
    const CSV_URL = 'https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/data/roaster.csv';
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let studentData = [];
    let missingSlots = [];

    document.getElementById('imageInput').addEventListener('change', handleImageUpload);

    async function loadCSV() {
      const res = await fetch(CSV_URL);
      const text = await res.text();
      const lines = text.trim().split('\n').slice(1);
      studentData = lines.map(line => {
        const [id, name, slot, grade, email] = line.split(',');
        return { id, name, slot: slot.replace(/"/g, ''), grade, email };
      });
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        detectEmptySlots(img);
      };
      img.src = URL.createObjectURL(file);
    }

    function detectEmptySlots(img) {
      // Placeholder logic: simulate missing slots
      // Replace with real image detection using TensorFlow.js or opencv.js
      missingSlots = ['9A1', '9A3']; // Example missing slots
      showMissingStudents();
    }

    function showMissingStudents() {
      const missingStudents = studentData.filter(s => missingSlots.includes(s.slot));
      const list = document.getElementById('missingList');
      list.innerHTML = `<h3>Missing Phones:</h3><ul>` +
        missingStudents.map(s => `<li>${s.name} (${s.slot}) - ${s.email}</li>`).join('') +
        `</ul>`;
    }

    function emailMissing() {
      const emails = studentData
        .filter(s => missingSlots.includes(s.slot))
        .map(s => s.email)
        .join(',');
      const subject = encodeURIComponent('Missing Phone Notification');
      const body = encodeURIComponent('Please come pick up your phone from the office.');
      window.location.href = `mailto:${emails}?subject=${subject}&body=${body}`;
    }

    loadCSV();
  </script>
</body>
</html>
