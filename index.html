<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Phone Box – Phone Cabinet Scanner</title>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <!-- All logic is local except a call to your external AI endpoint -->
  <script type="text/babel" data-presets="env,react">
    const { useState, useRef, useEffect } = React;

    // --- Icons ---
    function Icon({ children, className = "", size = 24 }) {
      return (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          className={className}
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          {children}
        </svg>
      );
    }

    const CameraIcon = (props) => (
      <Icon {...props}>
        <path d="M3 7h4l2-3h6l2 3h4v12H3z" />
        <circle cx="12" cy="13" r="4" />
      </Icon>
    );

    const UploadIcon = (props) => (
      <Icon {...props}>
        <path d="M4 17v3h16v-3" />
        <path d="M12 3v12" />
        <path d="m8 7 4-4 4 4" />
      </Icon>
    );

    const XIcon = (props) => (
      <Icon {...props}>
        <line x1="18" y1="6" x2="6" y2="18" />
        <line x1="6" y1="6" x2="18" y2="18" />
      </Icon>
    );

    const AlertCircleIcon = (props) => (
      <Icon {...props}>
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <circle cx="12" cy="16" r="1" />
      </Icon>
    );

    const CheckCircleIcon = (props) => (
      <Icon {...props}>
        <circle cx="12" cy="12" r="10" />
        <path d="m9 12 2 2 4-4" />
      </Icon>
    );

    const UserXIcon = (props) => (
      <Icon {...props}>
        <circle cx="9" cy="7" r="4" />
        <path d="M3 21a6 6 0 0 1 12 0" />
        <line x1="17" y1="9" x2="21" y2="13" />
        <line x1="21" y1="9" x2="17" y2="13" />
      </Icon>
    );

    /**
     * Call an external AI vision API instead of local <canvas> processing.
     * Expected request body (example):
     * {
     *   "image_base64": "<base64 string without data: prefix>",
     *   "rows": 6,
     *   "cols": 10,
     *   "threshold": 150,
     *   "boxId": "9A"
     * }
     *
     * Expected response:
     * {
     *   "emptySlots": [1, 5, 22],
     *   "confidence": "high"
     * }
     */
    async function analyzeImageWithAPI(base64Image, options = {}) {
      const {
        rows = 6,
        cols = 10,
        threshold = 150,
        boxId = "",
      } = options;

      // Strip "data:image/...;base64," prefix to keep payload smaller
      const base64Clean = base64Image.replace(/^data:image\/[a-zA-Z]+;base64,/, "");

      const response = await fetch("https://school120-phone-box.hf.space/analyze", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // If your external API needs a secret key,
          // DO NOT put it here in production. Use a backend proxy instead.
          // "Authorization": "Bearer YOUR_API_KEY",
        },
        body: JSON.stringify({
          image_base64: base64Clean,
          rows,
          cols,
          threshold,
          boxId,
        }),
      });

      if (!response.ok) {
        const text = await response.text().catch(() => "");
        throw new Error(`AI API error (${response.status}): ${text || "Unknown error"}`);
      }

      const data = await response.json();

      return {
        emptySlots: Array.isArray(data.emptySlots) ? data.emptySlots : [],
        confidence: data.confidence || "unknown",
      };
    }

    function App() {
      const [students, setStudents] = useState([]);
      const [absentStudents, setAbsentStudents] = useState([]);
      const [selectedBox, setSelectedBox] = useState("");
      const [capturedImage, setCapturedImage] = useState(null);
      const [analysis, setAnalysis] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [rosterLoaded, setRosterLoaded] = useState(false);
      const [threshold, setThreshold] = useState(150); // UI slider

      const fileInputRef = useRef(null);
      const cameraInputRef = useRef(null);
      const absentInputRef = useRef(null);

      const boxes = [
        "9A","9B","9C","9D","9E",
        "10A","10B","10C","10D","10E",
        "11A","11B","11C","11D","11E",
        "12A","12B","12C","12D","12E",
        "SM1","SM2"
      ];

      const parseCSV = (text) => {
        const lines = text.split("\n");
        if (lines.length <= 1) return [];
        return lines
          .slice(1)
          .filter((line) => line.trim())
          .map((line) => {
            const values = line.split(",").map((v) => v.trim().replace(/"/g, ""));
            return {
              personId: values[0] || "",
              fullName: values[1] || "",
              grade: values[2] || "",
              gender: values[3] || "",
              securityNumber: values[4] || "",
            };
          });
      };

      const loadFromGoogleSheets = async () => {
        const sheetUrl =
          "https://docs.google.com/spreadsheets/d/1k4lbcp-Xj32V2BntP938tTrp8M0Fr8uGcMHD0dV-Ito/export?format=csv&gid=264071587";
        setLoading(true);
        try {
          const response = await fetch(sheetUrl);
          const text = await response.text();
          const parsed = parseCSV(text);
          setStudents(parsed);
          setRosterLoaded(true);
          setError(null);
        } catch (err) {
          console.error("Failed to load roster from Google Sheets:", err);
          setError(
            "Failed to auto-load roster from Google Sheets. Try uploading CSV instead."
          );
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        if (!rosterLoaded) {
          loadFromGoogleSheets();
        }
      }, [rosterLoaded]);

      const handleCSVUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          const parsed = parseCSV(event.target.result);
          setStudents(parsed);
          setRosterLoaded(true);
          setError(null);
        };
        reader.readAsText(file);
      };

      const handleAbsentListUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          const text = event.target.result;
          const lines = text
            .split(/[\n,]/)
            .map((l) => l.trim())
            .filter((l) => l);
          setAbsentStudents(lines);
          setError(null);
        };
        reader.readAsText(file);
      };

      const handleImageCapture = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          setCapturedImage(event.target.result);
          setAnalysis(null);
          setError(null);
        };
        reader.readAsDataURL(file);
      };

      const isStudentAbsent = (student) => {
        return absentStudents.some((absent) =>
          student.fullName.toLowerCase().includes(absent.toLowerCase()) ||
          student.personId === absent ||
          absent.toLowerCase().includes(student.fullName.toLowerCase())
        );
      };

      const analyzeImage = async () => {
        if (!capturedImage || !selectedBox || students.length === 0) {
          setError("Please load roster, select a box, and capture an image first.");
          return;
        }

        setLoading(true);
        setError(null);
        setAnalysis(null);

        try {
          const boxStudents = students.filter((s) =>
            (s.securityNumber || "").startsWith(selectedBox)
          );

          const { emptySlots, confidence } = await analyzeImageWithAPI(
            capturedImage,
            {
              rows: 6,
              cols: 10,
              threshold: Number(threshold),
              boxId: selectedBox,
            }
          );

          const missingStudents = emptySlots
            .map((slot) => {
              return boxStudents.find((s) => {
                const sec = s.securityNumber || "";
                const match = sec.match(/(\d+)$/);
                if (match) {
                  return parseInt(match[0], 10) === slot;
                }
                return false;
              });
            })
            .filter(Boolean);

          const presentMissing = missingStudents.filter((s) => !isStudentAbsent(s));
          const absentMissing = missingStudents.filter((s) => isStudentAbsent(s));

          setAnalysis({
            emptySlots,
            missingStudents: presentMissing,
            absentMissing,
            totalStudentsInBox: boxStudents.length,
            confidence: confidence || "unknown",
          });
          setLoading(false);
        } catch (err) {
          console.error("Analysis error:", err);
          setError("Analysis failed: " + err.message);
          setLoading(false);
        }
      };

      const reset = () => {
        setCapturedImage(null);
        setAnalysis(null);
        setError(null);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                <CameraIcon className="text-indigo-600" size={32} />
                Phone Box – Phone Cabinet Scanner
              </h1>
              <p className="text-gray-600 mb-2">
                Scan phone cabinets and automatically identify missing phones.
              </p>
              <p className="text-xs text-gray-500 mb-4">
                Image analysis is done by your configured AI endpoint.
              </p>

              {/* Step 1: Load roster */}
              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Step 1: Load Student Roster
                </label>
                <div className="space-y-2">
                  <button
                    onClick={loadFromGoogleSheets}
                    disabled={loading}
                    className="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-medium disabled:bg-gray-400"
                  >
                    {loading && !students.length
                      ? "Loading from Google Sheets..."
                      : "Reload from Google Sheets"}
                  </button>
                  <div className="flex items-center gap-2">
                    <div className="flex-1 border-t border-gray-300"></div>
                    <span className="text-gray-500 text-xs">OR</span>
                    <div className="flex-1 border-t border-gray-300"></div>
                  </div>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleCSVUpload}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                  />
                </div>
                {students.length > 0 && (
                  <p className="mt-2 text-sm text-green-600 flex items-center gap-1">
                    <CheckCircleIcon size={16} />
                    {students.length} students loaded
                  </p>
                )}
              </div>

              {/* Optional absent list */}
              <div className="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                  <UserXIcon size={18} className="text-yellow-600" />
                  Optional: Upload Absent List
                </label>
                <p className="text-xs text-gray-600 mb-2">
                  Upload a text or CSV file with absent student names or IDs (one per line)
                </p>
                <button
                  onClick={() => absentInputRef.current?.click()}
                  className="w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition font-medium"
                >
                  Upload Absent List
                </button>
                <input
                  ref={absentInputRef}
                  type="file"
                  accept=".txt,.csv"
                  onChange={handleAbsentListUpload}
                  className="hidden"
                />
                {absentStudents.length > 0 && (
                  <div className="mt-2">
                    <p className="text-sm text-yellow-800 flex items-center gap-1">
                      <CheckCircleIcon size={16} />
                      {absentStudents.length} absent entries loaded
                    </p>
                    <button
                      onClick={() => setAbsentStudents([])}
                      className="text-xs text-yellow-700 underline mt-1"
                    >
                      Clear absent list
                    </button>
                  </div>
                )}
              </div>

              {/* Step 2: Select Box */}
              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Step 2: Select Box to Scan
                </label>
                <select
                  value={selectedBox}
                  onChange={(e) => setSelectedBox(e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                  <option value="">-- Select a Box --</option>
                  {boxes.map((box) => (
                    <option key={box} value={box}>
                      {box}
                    </option>
                  ))}
                </select>
              </div>

              {/* Step 3: Capture Photo */}
              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Step 3: Capture Cabinet Photo
                </label>
                <div className="flex gap-2">
                  <button
                    onClick={() => cameraInputRef.current?.click()}
                    className="flex-1 bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2 font-medium"
                  >
                    <CameraIcon size={20} />
                    Take Photo
                  </button>
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="flex-1 bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center justify-center gap-2 font-medium"
                  >
                    <UploadIcon size={20} />
                    Upload
                  </button>
                </div>
                <input
                  ref={cameraInputRef}
                  type="file"
                  accept="image/*"
                  capture="environment"
                  onChange={handleImageCapture}
                  className="hidden"
                />
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleImageCapture}
                  className="hidden"
                />
              </div>

              {/* Threshold slider */}
              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Brightness Threshold (hint for AI, if used)
                </label>
                <input
                  type="range"
                  min="80"
                  max="220"
                  value={threshold}
                  onChange={(e) => setThreshold(e.target.value)}
                  className="w-full"
                />
                <p className="text-xs text-gray-600 mt-1">
                  Current: <span className="font-mono">{threshold}</span>
                </p>
              </div>

              {/* Preview image */}
              {capturedImage && (
                <div className="mb-6 relative">
                  <img
                    src={capturedImage}
                    alt="Captured cabinet"
                    className="w-full rounded-lg border-2 border-gray-200"
                  />
                  <button
                    onClick={reset}
                    className="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition"
                  >
                    <XIcon size={20} />
                  </button>
                </div>
              )}

              {/* Analyze button */}
              {capturedImage && selectedBox && students.length > 0 && !analysis && (
                <button
                  onClick={analyzeImage}
                  disabled={loading}
                  className="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                  {loading ? "Analyzing..." : "Analyze Cabinet with AI"}
                </button>
              )}

              {error && (
                <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2">
                  <AlertCircleIcon
                    className="text-red-600 flex-shrink-0 mt-0.5"
                    size={20}
                  />
                  <p className="text-red-800 text-sm">{error}</p>
                </div>
              )}
            </div>

            {/* Results */}
            {analysis && (
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                  Results for Box {selectedBox}
                </h2>

                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-gray-600 mb-1">
                    Empty Slots:{" "}
                    <span className="font-bold">
                      {analysis.emptySlots.length > 0
                        ? analysis.emptySlots.join(", ")
                        : "None"}
                    </span>
                  </p>
                  <p className="text-sm text-gray-600">
                    Confidence:{" "}
                    <span className="font-bold capitalize">
                      {analysis.confidence}
                    </span>
                  </p>
                </div>

                {analysis.absentMissing.length > 0 && (
                  <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h4 className="font-semibold text-yellow-800 mb-2 flex items-center gap-2">
                      <UserXIcon size={18} />
                      Absent Students ({analysis.absentMissing.length})
                    </h4>
                    <div className="space-y-1">
                      {analysis.absentMissing.map((student, idx) => (
                        <p key={idx} className="text-sm text-yellow-700">
                          • {student.fullName}
                        </p>
                      ))}
                    </div>
                  </div>
                )}

                <h3 className="text-xl font-semibold text-gray-800 mb-3">
                  Missing Phones - Action Required ({analysis.missingStudents.length})
                </h3>

                {analysis.missingStudents.length === 0 ? (
                  <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p className="text-green-800 font-medium flex items-center gap-2">
                      <CheckCircleIcon size={20} />
                      All present students have turned in their phones!
                    </p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {analysis.missingStudents.map((student, idx) => (
                      <div
                        key={idx}
                        className="p-4 bg-red-50 border border-red-200 rounded-lg"
                      >
                        <p className="font-semibold text-gray-800">
                          {student.fullName}
                        </p>
                        <p className="text-sm text-gray-600">
                          ID: {student.personId} • {student.grade} • Slot:{" "}
                          {student.securityNumber}
                        </p>
                      </div>
                    ))}
                  </div>
                )}

                <button
                  onClick={reset}
                  className="mt-6 w-full bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition font-semibold"
                >
                  Scan Another Box
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
