<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phone Attendance Analyzer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<style>
  body {
    background-color: #0b0c10;
    color: #fff;
    margin: 0; padding: 0;
  }
  .container {
    padding: 1rem;
  }
  #preview {
    max-width: 100%;
    border: 2px solid #222;
    margin-top: 10px;
  }
  #overlay {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
  }
  .controls {
    display: flex;
    flex-direction: column;
    gap: .5rem;
  }
  .slider-group {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .slider-group label {
    flex: 1;
  }
  .slider-group input {
    flex: 2;
  }
  .fixed {
    position: relative;
    text-align: center;
  }
  #status { font-size: .9rem; color: #999; }
</style>
</head>

<body>
<main class="container">
  <h2>ðŸ“± Phone Attendance Analyzer</h2>

  <div class="controls">
    <label>Upload Photo:</label>
    <input type="file" id="photo" accept="image/*">

    <label>Use Roster:</label>
    <select id="rosterSource">
      <option value="repo">Use repo roster (/data/roster.csv)</option>
      <option value="upload">Upload new CSV</option>
    </select>
    <input type="file" id="rosterFile" accept=".csv" style="display:none;">

    <div class="slider-group">
      <label>Presence Threshold</label>
      <input type="range" id="presence" min="0.3" max="0.9" step="0.01" value="0.55">
    </div>

    <div class="slider-group">
      <label>Band top (%)</label>
      <input type="range" id="bandTop" min="0" max="100" step="1" value="40">
    </div>

    <div class="slider-group">
      <label>Band bottom (%)</label>
      <input type="range" id="bandBot" min="0" max="100" step="1" value="70">
    </div>

    <button id="analyze">Analyze</button>
    <p id="status">Waiting for image...</p>
  </div>

  <div class="fixed">
    <canvas id="preview"></canvas>
    <canvas id="overlay"></canvas>
  </div>
</main>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script>
let roster = [];
const preview = document.getElementById('preview');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const statusEl = document.getElementById('status');

const presenceEl = document.getElementById('presence');
const bandTopEl = document.getElementById('bandTop');
const bandBotEl = document.getElementById('bandBot');

async function loadRoster(){
  statusEl.textContent = 'Loading /data/roster.csv...';
  try {
    const res = await fetch('/data/roster.csv', { cache: 'no-store' });
    if (res.ok) {
      roster = parseCSV(await res.text());
      statusEl.textContent = 'Roster loaded âœ“';
      return;
    }
  } catch (e) {
    console.warn(e);
  }
  statusEl.textContent = 'Could not load /data/roster.csv (upload below).';
}

function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(',');
  return lines.map(l=>{
    const v=l.split(',');
    return Object.fromEntries(headers.map((h,i)=>[h.trim(),v[i]?.trim()]));
  });
}

document.getElementById('rosterSource').addEventListener('change', e=>{
  const up = document.getElementById('rosterFile');
  up.style.display = e.target.value==='upload'?'block':'none';
});
document.getElementById('rosterFile').addEventListener('change', e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{ roster=parseCSV(ev.target.result); statusEl.textContent='Custom roster loaded âœ“'; };
  reader.readAsText(file);
});

document.getElementById('photo').addEventListener('change', e=>{
  const file=e.target.files[0];
  if(!file) return;
  const img=new Image();
  img.onload=()=>{
    preview.width=img.width;
    preview.height=img.height;
    overlay.width=img.width;
    overlay.height=img.height;
    preview.getContext('2d').drawImage(img,0,0);
    statusEl.textContent='Image ready. Press Analyze.';
  };
  img.src=URL.createObjectURL(file);
});

document.getElementById('analyze').addEventListener('click', ()=>{
  analyze();
});

function applyCLAHE(gray) {
  const clahe = new cv.CLAHE(2.0, new cv.Size(8,8));
  const dst = new cv.Mat();
  clahe.apply(gray, dst);
  clahe.delete();
  return dst;
}

function slotConfidence(r){
  const c=document.createElement('canvas'); c.width=r.w; c.height=r.h;
  const cx=c.getContext('2d',{willReadFrequently:true});
  cx.drawImage(preview, r.x,r.y,r.w,r.h, 0,0,r.w,r.h);
  const imgData=cx.getImageData(0,0,r.w,r.h);
  const mat=cv.matFromImageData(imgData);
  const gray0=new cv.Mat(); cv.cvtColor(mat,gray0,cv.COLOR_RGBA2GRAY);
  const gray = applyCLAHE(gray0); gray0.delete();

  const y0=Math.round(r.h*(+bandTopEl.value/100));
  const y1=Math.round(r.h*(+bandBotEl.value/100));
  const xL=Math.round(r.w*0.10), xR=Math.round(r.w*0.90);
  const roi=gray.roi(new cv.Rect(xL,y0,Math.max(12,xR-xL),Math.max(12,y1-y0)));

  const sob16=new cv.Mat(), sob=new cv.Mat();
  cv.Sobel(roi,sob16,cv.CV_16S,0,1,3,1,0,cv.BORDER_DEFAULT);
  cv.convertScaleAbs(sob16,sob);
  const thrE=new cv.Mat(); cv.threshold(sob,thrE,0,255,cv.THRESH_BINARY|cv.THRESH_OTSU);
  let edgeFrac=0;
  for(let y=0;y<thrE.rows;y++){ const p=thrE.ptr(y); let c1=0; for(let x=0;x<thrE.cols;x++) if(p[x]) c1++; edgeFrac=Math.max(edgeFrac,c1/thrE.cols); }

  const inv=new cv.Mat(); cv.threshold(roi, inv, 0, 255, cv.THRESH_BINARY_INV|cv.THRESH_OTSU);
  const cnts=new cv.MatVector(), hier=new cv.Mat();
  cv.findContours(inv, cnts, hier, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
  let holes=0;
  for(let i=0;i<cnts.size();i++){
    const rct=cv.boundingRect(cnts.get(i));
    const area=rct.width*rct.height;
    const ar = rct.width / Math.max(1,rct.height);
    if(area>=6 && area<=Math.max(60, (r.w*r.h)*0.08) && ar<=6 && rct.height>=3) holes++;
  }
  const holeScore=Math.max(0, Math.min(1, holes/3));

  const mean=new cv.Mat(), std=new cv.Mat(); cv.meanStdDev(roi, mean, std);
  const tex = Math.max(0, Math.min(1, (std.doubleAt(0,0)**2)/300.0 ));

  const conf = Math.max(0, Math.min(1, 0.45*edgeFrac + 0.35*holeScore + 0.20*tex));

  [mat,gray,roi,sob16,sob,thrE,inv,cnts,hier,mean,std].forEach(m=>m?.delete?.());
  return conf;
}

function analyze(){
  if(!preview.width) return;
  const ctxP=preview.getContext('2d');
  const imgData=ctxP.getImageData(0,0,preview.width,preview.height);
  overlay.width=preview.width; overlay.height=preview.height;
  ctx.clearRect(0,0,overlay.width,overlay.height);

  const rows=5, cols=12;
  const padX=0.07, padY=0.05;
  const slotW=(1-2*padX)*preview.width/cols;
  const slotH=(1-2*padY)*preview.height/rows;

  for(let r=0;r<rows;r++){
    const y = padY*preview.height + r*slotH;
    for(let c=0;c<cols;c++){
      const x = padX*preview.width + c*slotW;
      const conf = slotConfidence({x,y,w:slotW,h:slotH});
      ctx.strokeStyle='#00aaff';
      ctx.lineWidth=2;
      ctx.strokeRect(x,y,slotW,slotH);
      ctx.fillStyle = conf>(+presenceEl.value)?'rgba(0,255,0,0.3)':'rgba(255,0,0,0.3)';
      ctx.fillRect(x,y,slotW,slotH);
    }
  }
  statusEl.textContent='Analysis complete âœ“';
}

loadRoster();
</script>
</body>
</html>
