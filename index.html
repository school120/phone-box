<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Phone Cabinet Scanner (OpenCV Version)</title>

<!-- React + Babel -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- OpenCV.js -->
<script async src="https://docs.opencv.org/4.7.0/opencv.js"></script>

</head>
<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">

const { useState, useRef, useEffect } = React;

// Delay until OpenCV finishes loading
function useOpenCV() {
  const [ready, setReady] = useState(false);
  useEffect(() => {
    let interval = setInterval(() => {
      if (window.cv && window.cv.imread) {
        clearInterval(interval);
        setReady(true);
      }
    }, 100);
  }, []);
  return ready;
}

/**
 * DETECT EMPTY SLOTS USING OPENCV
 * Divides the cabinet into a 6x10 grid and checks brightness of foam vs phone.
 */
function detectEmptySlots(imageDataUrl) {
  return new Promise((resolve) => {
    let img = document.createElement("img");
    img.src = imageDataUrl;

    img.onload = () => {
      // Draw onto canvas
      let canvas = document.createElement("canvas");
      let ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      let src = cv.imread(canvas);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

      // Crop interior (tuned for your cabinet photo)
      let h = gray.rows;
      let w = gray.cols;

      let top = Math.floor(0.07 * h);
      let bottom = Math.floor(0.94 * h);
      let left = Math.floor(0.07 * w);
      let right = Math.floor(0.93 * w);

      let roi = gray.roi(new cv.Rect(left, top, right-left, bottom-top));

      let rows = 6;
      let cols = 10;

      let slotH = roi.rows / rows;
      let slotW = roi.cols / cols;

      let averageBrightness = cv.mean(roi)[0];
      let threshold = averageBrightness + 10; // Slots brighter than foam threshold = empty

      let emptySlots = [];
      let slot = 1;

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          let y = Math.floor(r * slotH);
          let x = Math.floor(c * slotW);
          let h2 = Math.floor(slotH);
          let w2 = Math.floor(slotW);

          let cell = roi.roi(new cv.Rect(x, y, w2, h2));
          let cellMean = cv.mean(cell)[0];

          if (cellMean > threshold) {
            emptySlots.push(slot);
          }

          cell.delete();
          slot++;
        }
      }

      roi.delete();
      src.delete();
      gray.delete();

      resolve(emptySlots);
    };
  });
}

function App() {
  const cvReady = useOpenCV();

  const [students, setStudents] = useState([]);
  const [absent, setAbsent] = useState([]);
  const [selectedBox, setSelectedBox] = useState("");
  const [image, setImage] = useState(null);
  const [analysis, setAnalysis] = useState(null);
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const fileRef = useRef();
  const camRef = useRef();
  const absentRef = useRef();

  const boxes = ["9A","9B","9C","9D","9E","10A","10B","10C","10D","10E","11A","11B","11C","11D","11E","12A","12B","12C","12D","12E","SM1","SM2"];

  const parseCSV = (txt) => {
    let lines = txt.split("\n");
    return lines.slice(1)
      .map(l => l.split(","))
      .filter(a => a.length >= 5)
      .map(r => ({
        personId: r[0]?.trim(),
        fullName: r[1]?.trim(),
        grade: r[2]?.trim(),
        gender: r[3]?.trim(),
        securityNumber: r[4]?.trim()
      }));
  };

  const loadRoster = (e) => {
    let file = e.target.files[0];
    if (!file) return;
    let fr = new FileReader();
    fr.onload = ev => setStudents(parseCSV(ev.target.result));
    fr.readAsText(file);
  };

  const loadAbsent = (e) => {
    let file = e.target.files[0];
    if (!file) return;
    let fr = new FileReader();
    fr.onload = ev => {
      let list = ev.target.result.split(/[\n,]/).map(x => x.trim()).filter(Boolean);
      setAbsent(list);
    };
    fr.readAsText(file);
  };

  const handleImage = (e) => {
    let file = e.target.files[0];
    if (!file) return;
    let fr = new FileReader();
    fr.onload = ev => setImage(ev.target.result);
    fr.readAsDataURL(file);
  };

  const isAbsent = (s) =>
    absent.some(a => a.toLowerCase() === s.fullName.toLowerCase() || a === s.personId);

  const analyze = async () => {
    try {
      if (!cvReady) return alert("OpenCV is still loading...");
      if (!image || !selectedBox || students.length === 0) {
        setError("Upload roster, choose box, upload photo.");
        return;
      }
      setLoading(true);
      setError(null);

      let empty = await detectEmptySlots(image);

      let boxStudents = students.filter(s => (s.securityNumber||"").startsWith(selectedBox));

      let missing = empty.map(slot => {
        return boxStudents.find(st => {
          let m = (st.securityNumber||"").match(/(\d+)$/);
          return m && parseInt(m[1]) === slot;
        });
      }).filter(Boolean);

      let presentMissing = missing.filter(s => !isAbsent(s));
      let absentMissing = missing.filter(s => isAbsent(s));

      setAnalysis({
        emptySlots: empty,
        missingStudents: presentMissing,
        absentMissing,
        confidence: "high",
      });

    } catch (err) {
      setError("Analysis failed: " + err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-4 max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold mb-4 text-center">Phone Cabinet Scanner (OpenCV)</h1>

      <div className="bg-white p-4 shadow rounded mb-4">
        <h2 className="font-semibold mb-2">1. Load Roster CSV</h2>
        <input type="file" accept=".csv" onChange={loadRoster}/>
        {students.length > 0 && <p className="text-green-600">{students.length} students loaded</p>}
      </div>

      <div className="bg-white p-4 shadow rounded mb-4">
        <h2 className="font-semibold mb-2">2. Optional: Absent List</h2>
        <input type="file" accept=".txt,.csv" onChange={loadAbsent}/>
        {absent.length > 0 && <p className="text-yellow-700">{absent.length} absent students loaded</p>}
      </div>

      <div className="bg-white p-4 shadow rounded mb-4">
        <h2 className="font-semibold mb-2">3. Select Box</h2>
        <select className="border p-2 w-full" value={selectedBox} onChange={e => setSelectedBox(e.target.value)}>
          <option value="">-- Choose --</option>
          {boxes.map(b => <option key={b}>{b}</option>)}
        </select>
      </div>

      <div className="bg-white p-4 shadow rounded mb-4">
        <h2 className="font-semibold mb-2">4. Upload Cabinet Photo</h2>
        <input type="file" accept="image/*" capture="environment" onChange={handleImage}/>
        {image && <img src={image} className="rounded mt-2"/>}
      </div>

      <button
        onClick={analyze}
        disabled={loading}
        className="w-full bg-blue-600 text-white p-3 rounded shadow mb-4 disabled:bg-gray-400"
      >
        {loading ? "Analyzing..." : "Analyze Cabinet"}
      </button>

      {error && <div className="bg-red-100 p-2 text-red-700">{error}</div>}

      {analysis && (
        <div className="bg-white p-4 shadow rounded mt-4">
          <h2 className="text-xl font-semibold mb-2">Results</h2>

          <p className="mb-2">
            <strong>Empty Slots:</strong> {analysis.emptySlots.join(", ") || "None"}
          </p>
          <p><strong>Confidence:</strong> {analysis.confidence}</p>

          <h3 className="mt-4 font-semibold">Missing Phones</h3>
          {analysis.missingStudents.length === 0
            ? <p className="text-green-600">All present students turned in their phones!</p>
            : analysis.missingStudents.map((s, i) => (
                <p key={i} className="bg-red-100 p-2 my-1">{s.fullName}</p>
              ))
          }

          {analysis.absentMissing.length > 0 && (
            <>
              <h3 className="mt-4 font-semibold text-yellow-700">Absent (Ignored)</h3>
              {analysis.absentMissing.map((s, i) => (
                <p key={i} className="bg-yellow-100 p-2 my-1">{s.fullName}</p>
              ))}
            </>
          )}
        </div>
      )}

    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

</script>

</body>
</html>
