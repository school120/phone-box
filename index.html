<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phone Cabinet Scanner</title>

  <!-- React & ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useRef } = React;

    // NOTE: change this to your deployed backend URL (no trailing slash)
    const API_BASE_URL = 'https://YOUR_BACKEND_URL_HERE';

    function IconWrapper({ children, className = "", size = 24 }) {
      return (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          className={className}
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          {children}
        </svg>
      );
    }

    function Camera({ className, size }) {
      return (
        <IconWrapper className={className} size={size}>
          <path d="M3 7h4l2-3h6l2 3h4v12H3z" />
          <circle cx="12" cy="13" r="4" />
        </IconWrapper>
      );
    }

    function Upload({ className, size }) {
      return (
        <IconWrapper className={className} size={size}>
          <path d="M4 17v3h16v-3" />
          <path d="M12 3v12" />
          <path d="m8 7 4-4 4 4" />
        </IconWrapper>
      );
    }

    function X({ className, size }) {
      return (
        <IconWrapper className={className} size={size}>
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </IconWrapper>
      );
    }

    function AlertCircle({ className, size }) {
      return (
        <IconWrapper className={className} size={size}>
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="8" x2="12" y2="12" />
          <circle cx="12" cy="16" r="1" />
        </IconWrapper>
      );
    }

    function CheckCircle({ className, size }) {
      return (
        <IconWrapper className={className} size={size}>
        <circle cx="12" cy="12" r="10" />
        <path d="m9 12 2 2 4-4" />
      </IconWrapper>
      );
    }

    function UserX({ className, size }) {
      return (
        <IconWrapper className={className} size={size}>
          <circle cx="9" cy="7" r="4" />
          <path d="M3 21a6 6 0 0 1 12 0" />
          <line x1="17" y1="9" x2="21" y2="13" />
          <line x1="21" y1="9" x2="17" y2="13" />
        </IconWrapper>
      );
    }

    function PhoneCabinetScanner() {
      const [students, setStudents] = useState([]);
      const [absentStudents, setAbsentStudents] = useState([]);
      const [selectedBox, setSelectedBox] = useState('');
      const [capturedImage, setCapturedImage] = useState(null);
      const [analysis, setAnalysis] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      const fileInputRef = useRef(null);
      const cameraInputRef = useRef(null);
      const absentInputRef = useRef(null);

      const boxes = [
        '9A', '9B', '9C', '9D', '9E',
        '10A', '10B', '10C', '10D', '10E',
        '11A', '11B', '11C', '11D', '11E',
        '12A', '12B', '12C', '12D', '12E',
        'SM1', 'SM2'
      ];

      const parseCSV = (text) => {
        const lines = text.split('\n');
        if (lines.length === 0) return [];
        return lines
          .slice(1)
          .filter(line => line.trim())
          .map(line => {
            const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
            return {
              personId: values[0],
              fullName: values[1],
              grade: values[2],
              gender: values[3],
              securityNumber: values[4],
            };
          });
      };

      const handleCSVUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          const text = event.target.result;
          const parsed = parseCSV(text);
          setStudents(parsed);
          setError(null);
        };
        reader.readAsText(file);
      };

      const handleAbsentListUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          const text = event.target.result;
          const lines = text
            .split(/[\n,]/)
            .map(l => l.trim())
            .filter(l => l);
          setAbsentStudents(lines);
          setError(null);
        };
        reader.readAsText(file);
      };

      const loadFromGoogleSheets = async () => {
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/1k4lbcp-Xj32V2BntP938tTrp8M0Fr8uGcMHD0dV-Ito/export?format=csv&gid=264071587';
        setLoading(true);
        try {
          const response = await fetch(sheetUrl);
          const text = await response.text();
          const parsed = parseCSV(text);
          setStudents(parsed);
          setError(null);
        } catch (err) {
          setError('Failed to load from Google Sheets. Try uploading CSV instead.');
        } finally {
          setLoading(false);
        }
      };

      const handleImageCapture = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          setCapturedImage(event.target.result); // data URL
          setError(null);
        };
        reader.readAsDataURL(file);
      };

      const isStudentAbsent = (student) => {
        return absentStudents.some(absent =>
          student.fullName.toLowerCase().includes(absent.toLowerCase()) ||
          student.personId === absent ||
          absent.toLowerCase().includes(student.fullName.toLowerCase())
        );
      };

      const analyzeImage = async () => {
        if (!capturedImage || !selectedBox || students.length === 0) {
          setError('Please upload student data, select a box, and capture an image');
          return;
        }

        setLoading(true);
        setError(null);

        try {
          const boxStudents = students.filter(s => {
            const secNum = s.securityNumber || '';
            return secNum.startsWith(selectedBox);
          });

          const prompt = `You are analyzing a phone storage cabinet. This cabinet has numbered slots arranged in rows.

I need you to identify which slots appear to be EMPTY (no phone present) in this image.

The slots are numbered 1-60, arranged in a 10x6 grid (10 columns, 6 rows).
- Row 1: Slots 1-10
- Row 2: Slots 11-20
- Row 3: Slots 21-30
- Row 4: Slots 31-40
- Row 5: Slots 41-50
- Row 6: Slots 51-60

Look carefully at each visible slot and identify which ones are EMPTY (no phone visible).

Respond ONLY with a JSON object in this exact format (no markdown, no backticks):

{
  "emptySlots": [1, 5, 23, 34],
  "totalSlotsVisible": 60,
  "confidence": "high"
}`;

          const response = await fetch(`${API_BASE_URL}/api/analyze-cabinet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              imageData: capturedImage,
              prompt,
            }),
          });

          if (!response.ok) {
            const errText = await response.text().catch(() => '');
            throw new Error(errText || `HTTP ${response.status}`);
          }

          const parsed = await response.json();

          const missingStudents = (parsed.emptySlots || [])
            .map(slot => {
              return boxStudents.find(s => {
                const secNum = s.securityNumber || '';
                const slotMatch = secNum.match(/(\d+)$/);
                if (slotMatch) {
                  return parseInt(slotMatch[0], 10) === slot;
                }
                return false;
              });
            })
            .filter(Boolean);

          const presentMissing = missingStudents.filter(s => !isStudentAbsent(s));
          const absentMissing = missingStudents.filter(s => isStudentAbsent(s));

          setAnalysis({
            emptySlots: parsed.emptySlots || [],
            missingStudents: presentMissing,
            absentMissing: absentMissing,
            totalStudentsInBox: boxStudents.length,
            confidence: parsed.confidence || 'unknown',
          });
        } catch (err) {
          setError('Analysis failed: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const reset = () => {
        setCapturedImage(null);
        setAnalysis(null);
        setError(null);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                <Camera className="text-indigo-600" size={32} />
                Phone Cabinet Scanner
              </h1>
              <p className="text-gray-600 mb-6">
                Scan phone cabinets and identify missing phones
              </p>

              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Step 1: Load Student Roster
                </label>
                <div className="space-y-2">
                  <button
                    onClick={loadFromGoogleSheets}
                    disabled={loading}
                    className="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-medium disabled:bg-gray-400"
                  >
                    {loading ? 'Loading...' : 'Load from Google Sheets'}
                  </button>
                  <div className="flex items-center gap-2">
                    <div className="flex-1 border-t border-gray-300"></div>
                    <span className="text-gray-500 text-xs">OR</span>
                    <div className="flex-1 border-t border-gray-300"></div>
                  </div>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleCSVUpload}
                    className="block w-full text-sm text-gray-500
                               file:mr-4 file:py-2 file:px-4
                               file:rounded-full file:border-0
                               file:text-sm file:font-semibold
                               file:bg-indigo-50 file:text-indigo-700
                               hover:file:bg-indigo-100"
                  />
                </div>
                {students.length > 0 && (
                  <p className="mt-2 text-sm text-green-600 flex items-center gap-1">
                    <CheckCircle size={16} />
                    {students.length} students loaded
                  </p>
                )}
              </div>

              <div className="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                  <UserX size={18} className="text-yellow-600" />
                  Optional: Upload Absent List
                </label>
                <p className="text-xs text-gray-600 mb-2">
                  Upload a text or CSV file with absent student names or IDs (one per line)
                </p>
                <button
                  onClick={() => absentInputRef.current && absentInputRef.current.click()}
                  className="w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition font-medium"
                >
                  Upload Absent List
                </button>
                <input
                  ref={absentInputRef}
                  type="file"
                  accept=".txt,.csv"
                  onChange={handleAbsentListUpload}
                  className="hidden"
                />
                {absentStudents.length > 0 && (
                  <div className="mt-2">
                    <p className="text-sm text-yellow-800 flex items-center gap-1">
                      <CheckCircle size={16} />
                      {absentStudents.length} absent students loaded
                    </p>
                    <button
                      onClick={() => setAbsentStudents([])}
                      className="text-xs text-yellow-700 underline mt-1"
                    >
                      Clear absent list
                    </button>
                  </div>
                )}
              </div>

              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Step 2: Select Box to Scan
                </label>
                <select
                  value={selectedBox}
                  onChange={(e) => setSelectedBox(e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                  <option value="">-- Select a Box --</option>
                  {boxes.map(box => (
                    <option key={box} value={box}>
                      {box}
                    </option>
                  ))}
                </select>
              </div>

              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Step 3: Capture Cabinet Photo
                </label>
                <div className="flex gap-2">
                  <button
                    onClick={() => cameraInputRef.current && cameraInputRef.current.click()}
                    className="flex-1 bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2 font-medium"
                  >
                    <Camera size={20} />
                    Take Photo
                  </button>
                  <button
                    onClick={() => fileInputRef.current && fileInputRef.current.click()}
                    className="flex-1 bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center justify-center gap-2 font-medium"
                  >
                    <Upload size={20} />
                    Upload
                  </button>
                </div>
                <input
                  ref={cameraInputRef}
                  type="file"
                  accept="image/*"
                  capture="environment"
                  onChange={handleImageCapture}
                  className="hidden"
                />
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleImageCapture}
                  className="hidden"
                />
              </div>

              {capturedImage && (
                <div className="mb-6 relative">
                  <img
                    src={capturedImage}
                    alt="Cabinet"
                    className="w-full rounded-lg border-2 border-gray-200"
                  />
                  <button
                    onClick={reset}
                    className="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition"
                  >
                    <X size={20} />
                  </button>
                </div>
              )}

              {capturedImage && selectedBox && students.length > 0 && !analysis && (
                <button
                  onClick={analyzeImage}
                  disabled={loading}
                  className="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                  {loading ? 'Analyzing...' : 'Analyze Cabinet'}
                </button>
              )}

              {error && (
                <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2">
                  <AlertCircle className="text-red-600 flex-shrink-0 mt-0.5" size={20} />
                  <p className="text-red-800 text-sm">{error}</p>
                </div>
              )}
            </div>

            {analysis && (
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                  Results for Box {selectedBox}
                </h2>

                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-gray-600 mb-1">
                    Empty Slots:{' '}
                    <span className="font-bold">
                      {analysis.emptySlots.length > 0
                        ? analysis.emptySlots.join(', ')
                        : 'None'}
                    </span>
                  </p>
                  <p className="text-sm text-gray-600">
                    Confidence:{' '}
                    <span className="font-bold capitalize">
                      {analysis.confidence}
                    </span>
                  </p>
                </div>

                {analysis.absentMissing.length > 0 && (
                  <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h4 className="font-semibold text-yellow-800 mb-2 flex items-center gap-2">
                      <UserX size={18} />
                      Absent Students ({analysis.absentMissing.length})
                    </h4>
                    <div className="space-y-1">
                      {analysis.absentMissing.map((student, idx) => (
                        <p key={idx} className="text-sm text-yellow-700">
                          • {student.fullName}
                        </p>
                      ))}
                    </div>
                  </div>
                )}

                <h3 className="text-xl font-semibold text-gray-800 mb-3">
                  Missing Phones - Action Required ({analysis.missingStudents.length})
                </h3>

                {analysis.missingStudents.length === 0 ? (
                  <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p className="text-green-800 font-medium flex items-center gap-2">
                      <CheckCircle size={20} />
                      All present students have turned in their phones!
                    </p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {analysis.missingStudents.map((student, idx) => (
                      <div
                        key={idx}
                        className="p-4 bg-red-50 border border-red-200 rounded-lg"
                      >
                        <p className="font-semibold text-gray-800">
                          {student.fullName}
                        </p>
                        <p className="text-sm text-gray-600">
                          ID: {student.personId} • {student.grade} • Slot:{' '}
                          {student.securityNumber}
                        </p>
                      </div>
                    ))}
                  </div>
                )}

                <button
                  onClick={reset}
                  className="mt-6 w-full bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition font-semibold"
                >
                  Scan Another Box
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PhoneCabinetScanner />);
  </script>
</body>
</html>
