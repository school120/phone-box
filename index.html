<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Phone Box Attendance</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
    h1 { margin-bottom: 10px; }
    canvas { max-width: 100%; border: 1px solid #ccc; margin-top: 10px; }
    #results { margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .controls { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>ðŸ“± Phone Box Attendance</h1>
  <div class="controls">
    <label>Choose Box:
      <select id="boxSelect">
        <option value="">Auto-detect from labels (OCR)</option>
        <option value="SM1">SM1</option>
        <option value="SM2">SM2</option>
        <option value="9A">9A</option>
        <option value="9B">9B</option>
        <option value="9C">9C</option>
        <option value="9D">9D</option>
        <option value="9E">9E</option>
        <option value="9F">9F</option>
      </select>
    </label>
    <br><br>
    <label>Roster CSV:
      <select id="rosterChoice">
        <option value="https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/data/roster.csv">Use GitHub CSV</option>
        <option value="upload">Upload CSV</option>
      </select>
    </label>
    <input type="file" id="rosterUpload" accept=".csv" style="display:none" />
    <br><br>
    <label>Upload Image:
      <input type="file" id="imageInput" accept="image/*" />
    </label>
    <br><br>
    <button onclick="analyze()">Analyze Attendance</button>
  </div>
  <canvas id="canvas"></canvas>
  <div id="results"></div>

  <script>
    let studentData = [];
    let detectedSlots = [];

    document.getElementById('rosterChoice').addEventListener('change', e => {
      document.getElementById('rosterUpload').style.display = e.target.value === 'upload' ? 'block' : 'none';
    });

    async function loadCSV() {
      return new Promise((resolve) => {
        const choice = document.getElementById('rosterChoice').value;
        if (choice === 'upload') {
          const file = document.getElementById('rosterUpload').files[0];
          if (!file) return resolve([]);
          Papa.parse(file, {
            header: true,
            complete: results => resolve(results.data)
          });
        } else {
          Papa.parse(choice, {
            download: true,
            header: true,
            complete: results => resolve(results.data)
          });
        }
      });
    }

    function onOpenCvReady() {
      console.log('OpenCV.js is ready');
    }

    async function analyze() {
      const file = document.getElementById('imageInput').files[0];
      if (!file) return alert('Please upload an image.');
      const img = new Image();
      img.onload = async () => {
        const canvas = document.getElementById('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        const boxType = document.getElementById('boxSelect').value;
        studentData = await loadCSV();

        const result = await Tesseract.recognize(img, 'eng');
        const text = result.data.text;
        const numbers = [...text.matchAll(/\b([1-9]|[1-5][0-9]|60)\b/g)].map(m => parseInt(m[1]));

        detectedSlots = numbers.map(n => ({ slot: n, x: 0, y: 0 }));

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<h2>Results</h2><table><thead><tr><th>Slot</th><th>Expected</th><th>Detected</th><th>Status</th></tr></thead><tbody>';

        for (let i = 1; i <= 60; i++) {
          const expected = studentData.find(s => (s['Security Number'] || '').includes(`${boxType}-${i}`) || (s['Security Number'] || '').includes(`${boxType}${i}`));
          const detected = detectedSlots.find(s => s.slot === i);
          const status = expected ? (detected ? 'ok' : 'missing') : (detected ? 'unexpected' : '');
          resultsDiv.innerHTML += `<tr><td>${i}</td><td>${expected ? expected['Full Name'] : ''}</td><td>${detected ? 'ðŸ“±' : ''}</td><td>${status}</td></tr>`;
        }

        resultsDiv.innerHTML += '</tbody></table>';
      };
      img.src = URL.createObjectURL(file);
    }
  </script>
</body>
</html>
